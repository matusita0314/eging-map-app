import 'dart:async';
import 'dart:ui' as ui;
import 'dart:typed_data';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';
import 'package:geolocator/geolocator.dart';
import '../../models/post_model.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import '../post/add_post_page.dart';
import '../../widgets/post_bottom_sheet.dart';
import '../post/post_detail_page.dart';
import '../../widgets/squid_loading_indicator.dart';

class MapPage extends StatefulWidget {
  final LatLng? initialFocusLocation;
  final String? focusedPostId;
  const MapPage({super.key, this.initialFocusLocation, this.focusedPostId});

  @override
  State<MapPage> createState() => _MapPageState();
}

class _MapPageState extends State<MapPage> with TickerProviderStateMixin {
  final Completer<GoogleMapController> _controller = Completer();
  static const LatLng _initialPosition = LatLng(35.681236, 139.767125);
  LatLng? _currentPosition;
  bool _isLoading = true;
  bool _iconsLoaded = false;
  
  BitmapDescriptor? _squidIcon;
  BitmapDescriptor? _tappedSquidIcon;
  Set<Marker> _markers = {};
  Marker? _tappedMarker; 

  final Map<String, Post> _postsCache = {};
  StreamSubscription<QuerySnapshot>? _postsSubscription;

  Post? _selectedPost;
  bool _isDarkMap = false;
  bool _didRunInitialSetup = false;
  double _minSquidSize = 0;
  double _dateRangeInDays = 7.0;
  MapType _currentMapType = MapType.normal;
  Timer? _filterDebounceTimer;
  String? _lastQueryHash;
  bool _isUpdating = false;
  final Duration _updateThrottle = const Duration(milliseconds: 5000);

  final String _darkMapStyle = '''
  [
    {
      "elementType": "geometry",
      "stylers": [
        {
          "color": "#242f3e"
        }
      ]
    },
    {
      "elementType": "labels.text.fill",
      "stylers": [
        {
          "color": "#746855"
        }
      ]
    },
    {
      "elementType": "labels.text.stroke",
      "stylers": [
        {
          "color": "#242f3e"
        }
      ]
    },
    {
      "featureType": "administrative.locality",
      "elementType": "labels.text.fill",
      "stylers": [
        {
          "color": "#d59563"
        }
      ]
    },
    {
      "featureType": "poi",
      "elementType": "labels.text.fill",
      "stylers": [
        {
          "color": "#d59563"
        }
      ]
    },
    {
      "featureType": "poi.park",
      "elementType": "geometry",
      "stylers": [
        {
          "color": "#263c3f"
        }
      ]
    },
    {
      "featureType": "poi.park",
      "elementType": "labels.text.fill",
      "stylers": [
        {
          "color": "#6b9a76"
        }
      ]
    },
    {
      "featureType": "road",
      "elementType": "geometry",
      "stylers": [
        {
          "color": "#38414e"
        }
      ]
    },
    {
      "featureType": "road",
      "elementType": "geometry.stroke",
      "stylers": [
        {
          "color": "#212a37"
        }
      ]
    },
    {
      "featureType": "road",
      "elementType": "labels.text.fill",
      "stylers": [
        {
          "color": "#9ca5b3"
        }
      ]
    },
    {
      "featureType": "road.highway",
      "elementType": "geometry",
      "stylers": [
        {
          "color": "#746855"
        }
      ]
    },
    {
      "featureType": "road.highway",
      "elementType": "geometry.stroke",
      "stylers": [
        {
          "color": "#1f2835"
        }
      ]
    },
    {
      "featureType": "road.highway",
      "elementType": "labels.text.fill",
      "stylers": [
        {
          "color": "#f3d19c"
        }
      ]
    },
    {
      "featureType": "transit",
      "elementType": "geometry",
      "stylers": [
        {
          "color": "#2f3948"
        }
      ]
    },
    {
      "featureType": "transit.station",
      "elementType": "labels.text.fill",
      "stylers": [
        {
          "color": "#d59563"
        }
      ]
    },
    {
      "featureType": "water",
      "elementType": "geometry",
      "stylers": [
        {
          "color": "#17263c"
        }
      ]
    },
    {
      "featureType": "water",
      "elementType": "labels.text.fill",
      "stylers": [
        {
          "color": "#515c6d"
        }
      ]
    },
    {
      "featureType": "water",
      "elementType": "labels.text.stroke",
      "stylers": [
        {
          "color": "#17263c"
        }
      ]
    }
  ]
  ''';

  @override
  void initState() {
    super.initState();
    print("--- MapPage initState ---");

    if (widget.initialFocusLocation != null) {
      _currentPosition = widget.initialFocusLocation;
      _isLoading = false; 
    } else {
      _getCurrentLocation();
    }

    if (widget.focusedPostId != null) {
      FirebaseFirestore.instance
          .collection('posts')
          .doc(widget.focusedPostId)
          .get()
          .then((doc) {
        if (doc.exists) {
          final post = Post.fromFirestore(doc);
          // ÂèñÂæó„Åó„ÅüÊäïÁ®ø„Çí„Ç≠„É£„ÉÉ„Ç∑„É•„Å´Áõ¥Êé•ËøΩÂä†„Åô„Çã
          _postsCache[post.id] = post;
          if (_iconsLoaded) {
            _updateMarkersFromCache();
          }
        }
      });
    }
    _initializePostsStream(); // ÈÄöÂ∏∏„ÅÆ„Çπ„Éà„É™„Éº„É†„ÇÇÈñãÂßã
  }

  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    if (!_didRunInitialSetup) {
      _loadCustomIcons();
      _didRunInitialSetup = true;
    }
  }
    
  @override
  void dispose() {
    _postsSubscription?.cancel();
    _filterDebounceTimer?.cancel();
    super.dispose();
  }

  Future<void> _loadCustomIcons() async {
    try {
      final double devicePixelRatio = MediaQuery.of(context).devicePixelRatio;
      String squidAssetPath;
      String tappedSquidAssetPath;

      if (devicePixelRatio >= 3.0) {
        squidAssetPath = 'assets/images/squid_144.png';
        tappedSquidAssetPath = 'assets/images/squid_red_144.png';
      } else if (devicePixelRatio >= 2.0) {
        squidAssetPath = 'assets/images/squid_96.png';
        tappedSquidAssetPath = 'assets/images/squid_red_96.png';
      } else {
        squidAssetPath = 'assets/images/squid_48.png';
        tappedSquidAssetPath = 'assets/images/squid_red_48.png';
      }

      final normalIcon = await BitmapDescriptor.fromAssetImage(
        ImageConfiguration(size: const Size(48, 48), devicePixelRatio: devicePixelRatio),
        squidAssetPath,
      );
      final tappedIcon = await BitmapDescriptor.fromAssetImage(
        ImageConfiguration(size: const Size(56, 56), devicePixelRatio: devicePixelRatio),
        tappedSquidAssetPath,
      );

      if (mounted) {
        setState(() {
          _squidIcon = normalIcon;
          _tappedSquidIcon = tappedIcon;
          _iconsLoaded = true;
        });
        _rebuildAllMarkers();
      }
    } catch (e) {
      print("[_loadCustomIcons] „Ç¢„Ç§„Ç≥„É≥Ë™≠„ÅøËæº„Åø„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü: $e");
    }
  }

  void _initializePostsStream() {
    final queryHash = '${_minSquidSize}_$_dateRangeInDays';
    if (_lastQueryHash == queryHash) return;
    _lastQueryHash = queryHash;
    _postsSubscription?.cancel();

    final startDate = DateTime.now().subtract(Duration(days: _dateRangeInDays.round()));
    Query query = FirebaseFirestore.instance.collection('posts').where('createdAt', isGreaterThanOrEqualTo: startDate);
    if (_minSquidSize > 0) {
      query = query.where('squidSize', isGreaterThanOrEqualTo: _minSquidSize);
    }
    _postsSubscription = query.snapshots().listen(_handlePostsSnapshot);
  }

  // üî• „Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„ÉàÂá¶ÁêÜ„ÇíÊúÄÈÅ©Âåñ
  void _handlePostsSnapshot(QuerySnapshot snapshot) {
    if (!mounted ) return;
    if (!_iconsLoaded || _isUpdating) return;
    _isUpdating = true;
    final changedPosts = <String, Post>{};
    final deletedPostIds = <String>{};
    for (final change in snapshot.docChanges) {
      final post = Post.fromFirestore(change.doc);
      switch (change.type) {
        case DocumentChangeType.added:
        case DocumentChangeType.modified:
          changedPosts[post.id] = post;
          break;
        case DocumentChangeType.removed:
          deletedPostIds.add(post.id);
          break;
      }
    }
    _postsCache.addAll(changedPosts);
    deletedPostIds.forEach(_postsCache.remove);
    _updateMarkersFromCache();
    Future.delayed(_updateThrottle, () { _isUpdating = false; });
  }

  // üî• „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Éû„Éº„Ç´„Éº„ÇíÂäπÁéáÁöÑ„Å´Êõ¥Êñ∞
  void _updateMarkersFromCache() {
    if (!mounted) return;

    final newMarkers = <Marker>{};
    for (final post in _postsCache.values) {
      newMarkers.add(_createMarkerFromPost(post));
    }
    if (_tappedMarker != null) {
      newMarkers.add(_tappedMarker!);
    }
    if (mounted) {
      setState(() { 
        _markers = newMarkers; 
      });
    }
  }

  Marker _createMarkerFromPost(Post post) {
    final bool isFocused = post.id == widget.focusedPostId;

    return Marker(
      markerId: MarkerId(post.id),
      position: post.location,
      icon: isFocused 
          ? (_tappedSquidIcon ?? BitmapDescriptor.defaultMarker) 
          : (_squidIcon ?? BitmapDescriptor.defaultMarker),
      zIndex: isFocused ? 1.0 : 0.0,
      onTap: () {
        setState(() {
          _selectedPost = post;
        });
      },
    );
  }

  void _rebuildAllMarkers() {
    if (!mounted) return;
    _updateMarkersFromCache();
  }

  Future<void> _toggleMapStyle() async {
    // ÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÂèçËª¢„Åï„Åõ„Çã
    final newIsDark = !_isDarkMap;
    // „Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®„Åô„ÇãÊñáÂ≠óÂàó„ÇíÊ±∫ÂÆöÔºà„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâOFF„Å™„ÇânullÔºâ
    final style = newIsDark ? _darkMapStyle : null;

    try {
      final controller = await _controller.future;
      // setMapStyle„Å´ÊñáÂ≠óÂàó„Åæ„Åü„ÅØnull„ÇíÊ∏°„Åô
      await controller.setMapStyle(style);
      // ÊàêÂäü„Åó„Åü„ÇâÁä∂ÊÖã„ÇíÊõ¥Êñ∞
      if (mounted) {
        setState(() {
          _isDarkMap = newIsDark;
        });
      }
    } catch (e) {
      ScaffoldMessenger.of(
        context,
      ).showSnackBar(const SnackBar(content: Text('„Éû„ÉÉ„Éó„Çπ„Çø„Ç§„É´„ÅÆÈÅ©Áî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ')));
    }
  }

  Future<void> _getCurrentLocation() async {
    try {
      bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
      if (!serviceEnabled) {
        if (mounted) setState(() => _isLoading = false);
        return;
      }

      LocationPermission permission = await Geolocator.checkPermission();
      if (permission == LocationPermission.denied) {
        permission = await Geolocator.requestPermission();
        if (permission == LocationPermission.denied) {
          if (mounted) setState(() => _isLoading = false);
          return;
        }
      }

      if (permission == LocationPermission.deniedForever) {
        if (mounted) setState(() => _isLoading = false);
        return;
      }

      Position position = await Geolocator.getCurrentPosition(
        desiredAccuracy: LocationAccuracy.high,
        timeLimit: const Duration(seconds: 10),
      );

      if (mounted) {
        setState(() {
          _currentPosition = LatLng(position.latitude, position.longitude);
          _isLoading = false;
        });
        _animateToPosition(_currentPosition!);
      }
    } catch (e) {
      print('‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: $e');
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  Future<void> _animateToPosition(LatLng position) async {
    try {
      final GoogleMapController controller = await _controller.future;
      await controller.animateCamera(
        CameraUpdate.newCameraPosition(
          CameraPosition(target: position, zoom: 14.0),
        ),
      );
    } catch (e) {
      print('„Ç´„É°„É©„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº: $e');
    }
  }

  void _onMapTapped(LatLng location) {
    setState(() {
      // Êñ∞Ë¶èÊäïÁ®øÁî®„ÅÆ„Éû„Éº„Ç´„Éº‰ª•Â§ñ„ÅÆÁä∂ÊÖã„ÅØÂ§âÊõ¥„Åó„Å™„ÅÑ
      _markers.removeWhere((m) => m.markerId.value == 'tapped_location');
      _tappedMarker = Marker(
        markerId: const MarkerId('tapped_location'),
        position: location,
        icon: BitmapDescriptor.defaultMarkerWithHue(BitmapDescriptor.hueRed),
      );
      _markers.add(_tappedMarker!);
    });
  }

  void _onAddPostButtonPressed() {
    if (_tappedMarker == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('„Éû„ÉÉ„Éó„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÊäïÁ®ø„Åô„ÇãÂ†¥ÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ')),
      );
      return;
    }

    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => AddPostPage(location: _tappedMarker!.position),
      ),
    );
  }

  // üî• „Éá„Éê„Ç¶„É≥„Çπ‰ªò„Åç„Éï„Ç£„É´„Çø„ÉºÊõ¥Êñ∞
  void _updateFilterWithDebounce() {
    _filterDebounceTimer?.cancel();
    _filterDebounceTimer = Timer(const Duration(milliseconds: 300), () {
      _initializePostsStream();
    });
  }

  void _showMapTypeDialog() {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        // „ÉÄ„Ç§„Ç¢„É≠„Ç∞ÂÜÖ„ÅÆÁä∂ÊÖã„ÇíÁÆ°ÁêÜ„Åô„Çã„Åü„ÇÅ„Å´StatefulBuilder„Çí‰ΩøÁî®
        return StatefulBuilder(
          builder: (context, setDialogState) {
            return AlertDialog(
              title: const Text('Ë°®Á§∫Ë®≠ÂÆö'),
              content: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Divider(),
                  const Text(
                    'Âú∞Âõ≥„Çø„Ç§„Éó',
                    style: TextStyle(fontWeight: FontWeight.bold),
                  ),
                  _buildMapTypeOption(MapType.normal, 'ÈÄöÂ∏∏', Icons.map),
                  _buildMapTypeOption(MapType.satellite, 'Ë°õÊòü', Icons.satellite),
                  const Divider(),
                  SwitchListTile(
                    title: const Text('„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ'),
                    secondary: const Icon(Icons.dark_mode_outlined),
                    value: _isDarkMap,
                    onChanged: (newValue) {
                      // „Çπ„Çø„Ç§„É´„ÇíÂàá„ÇäÊõø„Åà„Å¶„Åã„Çâ„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñâ„Åò„Çã
                      _toggleMapStyle().then((_) {
                        // „ÉÄ„Ç§„Ç¢„É≠„Ç∞ÂÜÖ„ÅÆ„Çπ„Ç§„ÉÉ„ÉÅË°®Á§∫„ÇíÂç≥ÊôÇÊõ¥Êñ∞
                        setDialogState(() {});
                      });
                    },
                  ),
                ],
              ),
              actions: [
                TextButton(
                  onPressed: () => Navigator.of(context).pop(),
                  child: const Text('Èñâ„Åò„Çã'),
                ),
              ],
            );
          },
        );
      },
    );
  }

  Widget _buildMapTypeOption(MapType type, String title, IconData icon) {
    return ListTile(
      leading: Icon(icon),
      title: Text(title),
      trailing: _currentMapType == type
          ? const Icon(Icons.check, color: Colors.blue)
          : null,
      onTap: () {
        setState(() {
          _currentMapType = type;
        });
        Navigator.of(context).pop();
      },
    );
  }

  Future<void> _onMapCreated(GoogleMapController controller) async {
    if (!_controller.isCompleted) {
      _controller.complete(controller);
    }
  }

  @override
  Widget build(BuildContext context) {

    final bool canPop = Navigator.canPop(context);

    return Scaffold(
      floatingActionButton: FloatingActionButton(
        heroTag: null,
        onPressed: _onAddPostButtonPressed,
        child: const Icon(Icons.add),
      ),
      body: _isLoading
          ? const SquidLoadingIndicator()
          : Stack(
        children: [
          GoogleMap(
            initialCameraPosition: CameraPosition(
              target: _currentPosition ?? _initialPosition,
              zoom: 12.0,
            ),
            onMapCreated: _onMapCreated,
            onTap: _onMapTapped,
            markers: _markers,
            myLocationEnabled: false,
            myLocationButtonEnabled: false,
            mapType: _currentMapType,
            zoomControlsEnabled: false,
            mapToolbarEnabled: false,
          ),

          if (canPop)
          Positioned(
            top: 0,
            left: 0,
            right: 0,
            child: SafeArea(
              child: Container(
                margin: const EdgeInsets.fromLTRB(16, 15, 16, 0),
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 8),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.95),
                  borderRadius: BorderRadius.circular(20),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.1),
                      blurRadius: 12,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: Row(
                  children: [
                    // Êàª„Çã„Éú„Çø„É≥
                    IconButton(
                      icon: const Icon(Icons.arrow_back, color: Color(0xFF13547a)),
                      onPressed: () => Navigator.of(context).pop(),
                    ),
                    // „Çø„Ç§„Éà„É´
                    const Expanded(
                      child: Text(
                        'Èá£Êûú„Éù„Ç§„É≥„Éà',
                        textAlign: TextAlign.center,
                        style: TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: Color(0xFF13547a),
                        ),
                      ),
                    ),
                    // Âè≥ÂÅ¥„ÅÆ„Çπ„Éö„Éº„ÇπÔºàÊàª„Çã„Éú„Çø„É≥„Å®„ÅÆ„Éê„É©„É≥„Çπ„Çí„Å®„Çã„Åü„ÇÅÔºâ
                    const SizedBox(width: 48),
                  ],
                ),
              ),
            ),
          ),
          
          _buildFilterChips(),
          _buildDateRangeSlider(),
          _buildMapTypeButton(),
          
          if (_selectedPost != null)
            // „Ç¶„Ç£„Ç∏„Çß„ÉÉ„Éà„ÇíÁîªÈù¢Â§ñ„Å´„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶Èñâ„Åò„ÇãÊìç‰Ωú„ÇíÊ§úÁü•
            NotificationListener<DraggableScrollableNotification>(
              onNotification: (notification) {
                // ÊúÄÂ∞è„Çµ„Ç§„Ç∫(0.15)„Çà„ÇäÂ∞è„Åï„Åè„Å™„Å£„Åü„ÇâÈñâ„Åò„Çã
                if (notification.extent <= 0.15) {
                  setState(() {
                    _selectedPost = null;
                  });
                }
                return true;
              },
              child: DraggableScrollableSheet(
                initialChildSize: 0.35, // ÂàùÊúüË°®Á§∫„ÅÆÈ´ò„Åï (35%)
                minChildSize: 0.15,      // ÊúÄÂ∞è„ÅÆÈ´ò„Åï (15%)
                maxChildSize: 0.8,       // ÊúÄÂ§ß„ÅÆÈ´ò„Åï (80%)
                builder: (context, scrollController) {
                  return PostBottomSheet(
                    post: _selectedPost!,
                    scrollController: scrollController, // ÂøÖÈ†àÔºö‰∏≠„ÅÆ„É™„Çπ„Éà„Å®ÈÄ£Êê∫„Åï„Åõ„Çã
                    onNavigateToDetail: () {
                      Navigator.of(context).push(MaterialPageRoute(
                        builder: (_) => PostDetailPage(post: _selectedPost!),
                      ));
                    },
                  );
                },
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildMapTypeButton() {
    return Positioned(
      bottom: 120,
      right: 10,
      child: Container(  // Container„ÇíËøΩÂä†
      width: 60,      // Â∏åÊúõ„ÅÆ„Çµ„Ç§„Ç∫„Å´Ë™øÊï¥
      height: 60,     // Â∏åÊúõ„ÅÆ„Çµ„Ç§„Ç∫„Å´Ë™øÊï¥
      child: FloatingActionButton(
        heroTag: null,
        mini: true,
        onPressed: _showMapTypeDialog,
        backgroundColor: Colors.white,
        foregroundColor: Colors.black54,
        tooltip: 'Ë°®Á§∫Ë®≠ÂÆö',
        child: Icon(
          _currentMapType == MapType.satellite ? Icons.map : Icons.satellite,
          size: 35,  // „Ç¢„Ç§„Ç≥„É≥„Çµ„Ç§„Ç∫„ÇÇË™øÊï¥
        ),
      ),
    ),
    );
  }

  Widget _buildFilterChips() {
  return Positioned(
    bottom: 200,
    right: 10,
    child: Container(
      width: 60,  // „Çµ„Ç§„Ç∫„ÇíÊåáÂÆö
      height: 60, // ÂπÖ„Å®È´ò„Åï„ÇíÂêå„Åò„Å´
      child: FloatingActionButton(
        heroTag: null,
        elevation: 6,
        backgroundColor: Colors.white,
        mini: true,
        onPressed: _showSizeFilterSheet,
        child: const Icon(
          Icons.straighten,
          size: 35,  // „Ç¢„Ç§„Ç≥„É≥„Çµ„Ç§„Ç∫„ÇíË™øÊï¥
          color: Colors.black54,
        ),
      ),
    ),
  );
}

  Widget _buildDateRangeSlider() {
    return Positioned(
      bottom: 10,
      left: 10,
      right: 10,
      child: Card(
        elevation: 4,
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text('Ë°®Á§∫ÊúüÈñì: ÈÅéÂéª ${_dateRangeInDays.round()} Êó•Èñì'),
              Slider(
                value: _dateRangeInDays,
                min: 1,
                max: 30,
                divisions: 29,
                label: '${_dateRangeInDays.round()}Êó•',
                onChanged: (double value) {
                  setState(() {
                    _dateRangeInDays = value;
                  });
                  _updateFilterWithDebounce();
                },
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showSizeFilterSheet() {
    showModalBottomSheet(
      context: context,
      builder: (context) {
        return StatefulBuilder(
          builder: (BuildContext context, StateSetter setModalState) {
            return Container(
              padding: const EdgeInsets.all(24.0),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    '„Ç§„Ç´„ÅÆÊúÄÂ∞è„Çµ„Ç§„Ç∫: ${_minSquidSize.round()} cm',
                    style: const TextStyle(fontSize: 16),
                  ),
                  Slider(
                    value: _minSquidSize,
                    min: 0,
                    max: 50,
                    divisions: 10,
                    label: '${_minSquidSize.round()} cm',
                    onChanged: (double value) {
                      setModalState(() {
                        _minSquidSize = value;
                      });
                    },
                  ),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.end,
                    children: [
                      TextButton(
                        child: const Text('„É™„Çª„ÉÉ„Éà'),
                        onPressed: () {
                          setState(() => _minSquidSize = 0);
                          Navigator.pop(context);
                          _updateFilterWithDebounce();
                        },
                      ),
                      ElevatedButton(
                        child: const Text('ÈÅ©Áî®'),
                        onPressed: () {
                          setState(() {});
                          Navigator.pop(context);
                          _updateFilterWithDebounce();
                        },
                      ),
                    ],
                  ),
                ],
              ),
            );
          },
        );
      },
    );
  }
}